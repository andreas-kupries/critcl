
<!DOCTYPE html><html><head>
<title>critcl::objtype - C Runtime In Tcl (CriTcl)</title>
<style type="text/css"><!--
    HTML {
	background: 	#FFFFFF;
	color: 		black;
    }
    BODY {
	background: 	#FFFFFF;
	color:	 	black;
    }
    DIV.doctools {
	margin-left:	10%;
	margin-right:	10%;
    }
    DIV.doctools H1,DIV.doctools H2 {
	margin-left:	-5%;
    }
    H1, H2, H3, H4 {
	margin-top: 	1em;
	font-family:	sans-serif;
	font-size:	large;
	color:		#005A9C;
	background: 	transparent;
	text-align:		left;
    }
    H1.doctools_title {
	text-align: center;
    }
    UL,OL {
	margin-right: 0em;
	margin-top: 3pt;
	margin-bottom: 3pt;
    }
    UL LI {
	list-style: disc;
    }
    OL LI {
	list-style: decimal;
    }
    DT {
	padding-top: 	1ex;
    }
    UL.doctools_toc,UL.doctools_toc UL, UL.doctools_toc UL UL {
	font:		normal 12pt/14pt sans-serif;
	list-style:	none;
    }
    LI.doctools_section, LI.doctools_subsection {
	list-style: 	none;
	margin-left: 	0em;
	text-indent:	0em;
	padding: 	0em;
    }
    PRE {
	display: 	block;
	font-family:	monospace;
	white-space:	pre;
	margin:		0%;
	padding-top:	0.5ex;
	padding-bottom:	0.5ex;
	padding-left:	1ex;
	padding-right:	1ex;
	width:		100%;
    }
    PRE.doctools_example {
	color: 		black;
	background: 	#f5dcb3;
	border:		1px solid black;
    }
    UL.doctools_requirements LI, UL.doctools_syntax LI {
	list-style: 	none;
	margin-left: 	0em;
	text-indent:	0em;
	padding:	0em;
    }
    DIV.doctools_synopsis {
	color: 		black;
	background: 	#80ffff;
	border:		1px solid black;
	font-family:	serif;
	margin-top: 	1em;
	margin-bottom: 	1em;
    }
    UL.doctools_syntax {
	margin-top: 	1em;
	border-top:	1px solid black;
    }
    UL.doctools_requirements {
	margin-bottom: 	1em;
	border-bottom:	1px solid black;
    }
--></style>
</head>
<!-- Generated from file 'critcl_objtype.man' by tcllib/doctools with format 'html'
   -->
<!-- Copyright &amp;copy; 2011-2018 Andreas Kupries
   -->
<!-- critcl::objtype.n
   -->
<body><hr> [
   <a href="../toc.html">Table Of Contents</a>
| <a href="../index.html">Keyword Index</a>
 ] <hr>
<div class="doctools">
<h1 class="doctools_title">critcl::objtype(n) 0 doc &quot;C Runtime In Tcl (CriTcl)&quot;</h1>
<div id="name" class="doctools_section"><h2><a name="name">Name</a></h2>
<p>critcl::objtype - CriTcl Utilities: Custom Tcl_ObjTypes</p>
</div>
<div id="toc" class="doctools_section"><h2><a name="toc">Table Of Contents</a></h2>
<ul class="doctools_toc">
<li class="doctools_section"><a href="#toc">Table Of Contents</a></li>
<li class="doctools_section"><a href="#synopsis">Synopsis</a></li>
<li class="doctools_section"><a href="#section1">Description</a></li>
<li class="doctools_section"><a href="#section2">API</a></li>
<li class="doctools_section"><a href="#section3">Examples</a>
<ul>
<li class="doctools_subsection"><a href="#subsection1">Handle</a></li>
<li class="doctools_subsection"><a href="#subsection2">Structure - Tagged Dict</a></li>
<li class="doctools_subsection"><a href="#subsection3">Structure - Dict</a></li>
<li class="doctools_subsection"><a href="#subsection4">Structure - Tagged List</a></li>
<li class="doctools_subsection"><a href="#subsection5">Structure - List</a></li>
</ul>
</li>
<li class="doctools_section"><a href="#section4">Authors</a></li>
<li class="doctools_section"><a href="#section5">Bugs, Ideas, Feedback</a></li>
<li class="doctools_section"><a href="#keywords">Keywords</a></li>
<li class="doctools_section"><a href="#category">Category</a></li>
<li class="doctools_section"><a href="#copyright">Copyright</a></li>
</ul>
</div>
<div id="synopsis" class="doctools_section"><h2><a name="synopsis">Synopsis</a></h2>
<div class="doctools_synopsis">
<ul class="doctools_requirements">
<li>package require <b class="pkgname">Tcl 8.4</b></li>
<li>package require <b class="pkgname">critcl <span class="opt">?3.1?</span></b></li>
<li>package require <b class="pkgname">critcl::objtype <span class="opt">?0?</span></b></li>
</ul>
<ul class="doctools_syntax">
<li><a href="#1"><b class="cmd">::critcl::objtype handle</b> <i class="arg">name</i> <span class="opt">?<i class="arg">option...</i>?</span></a></li>
<li><a href="#2"><b class="cmd">::critcl::objtype structure</b> <i class="arg">name</i> <i class="arg">spec</i> <span class="opt">?<i class="arg">option...</i>?</span></a></li>
</ul>
</div>
</div>
<div id="section1" class="doctools_section"><h2><a name="section1">Description</a></h2>
<p><i class="term">C Runtime In Tcl</i>, or <i class="term"><a href="critcl_pkg.html">CriTcl</a></i> , is a system for compiling C code
embedded in Tcl on the fly and either loading the resulting objects into Tcl for
immediate use or packaging them for distribution.  Use <i class="term"><a href="critcl_pkg.html">CriTcl</a></i> to improve
performance by rewriting in C those routines that are performance bottlenecks.</p>
<p>This document is the reference manpage for the <b class="package">critcl::objtype</b>
package. This package provides convenience commands for advanced functionality
built on top of the critcl core.</p>
<p>While Tcl comes with a variety of useful value types
(<b class="type">Tcl_ObjType</b>) built into the core there are situations which are best
dealt by using a custom Tcl_ObjType to handle the special values it came with.</p>
<p>With this package a developer can focus on the core handling for the
custom value, i.e. allocation, conversion into and out of strings, release,
etc., without having to deal with the boilerplate around it.</p>
<p>It's intended audience are mainly developers wishing to write Tcl
packages with embedded C code.</p>
<p>This package resides in the Core Package Layer of CriTcl.</p>
<p><img alt="arch_core" src="../image/arch_core.png"></p>
</div>
<div id="section2" class="doctools_section"><h2><a name="section2">API</a></h2>
<dl class="doctools_definitions">
<dt><a name="1"><b class="cmd">::critcl::objtype handle</b> <i class="arg">name</i> <span class="opt">?<i class="arg">option...</i>?</span></a></dt>
<dd><p>This command creates the C code for a custom <b class="type">Tcl_ObjType</b> with the
specified <i class="arg">name</i>.
<em>By default</em> it assumes the existence of a reference-counted opaque C
type of the same name, with five C functions to access the same, whose names
are derived from the name of the C type. The functions are expected to have
the signatures and behaviour given below:</p>
<dl class="doctools_definitions">
<dt>void <b class="function"><i class="arg">name</i>_ref</b> (&lt;name&gt; <i class="arg">x</i>)</dt>
<dd><p>Aquire a reference to object <i class="arg">x</i>.</p></dd>
<dt>void <b class="function"><i class="arg">name</i>_unref</b> (&lt;name&gt; <i class="arg">x</i>)</dt>
<dd><p>Release a reference to object <i class="arg">x</i>. The function has to destroy <i class="arg">x</i>
when its reference counts drops below <b class="const">1</b>.</p></dd>
<dt>void <b class="function"><i class="arg">name</i>_to_string</b> (&lt;name&gt; <i class="arg">x</i>, Tcl_DString* <i class="arg">ds</i>)</dt>
<dd><p>Serialize object <i class="arg">x</i> into the <b class="type">Tcl_DString*</b> variable <i class="arg">ds</i>.
The DString is initialized and empty when the function is called.</p></dd>
<dt>&lt;name&gt; <b class="function"><i class="arg">name</i>_to_value</b> (Tcl_Interp* <i class="arg">interp</i>, Tcl_Obj* <i class="arg">obj</i>)</dt>
<dd><p>Deserialize (the string representation of) <i class="arg">obj</i> into an object of the
type and return it. The function has to return <b class="const">NULL</b> on error.</p></dd>
<dt>int <b class="function"><i class="arg">name</i>_refcount</b> (&lt;name&gt; <i class="arg">x</i>)</dt>
<dd><p>Return the number of references to <i class="arg">x</i>. Note that the generated C code
uses this function only in <b class="const">TRACE_...</b> statements.</p></dd>
</dl>
<p>All of the above can be overridden by one or more option arguments following
the <i class="arg">name</i>. The recognized options are:</p>
<dl class="doctools_options">
<dt><b class="option">-type</b> <i class="arg">string</i></dt>
<dd><p>This option overrides the name of the C type managed by the new type. The
names of the expected functions change accordingly, if not overridden by any
of the following options.</p></dd>
<dt><b class="option">-ref</b> <i class="arg">string</i></dt>
<dd></dd>
<dt><b class="option">-unref</b> <i class="arg">string</i></dt>
<dd></dd>
<dt><b class="option">-refcount</b> <i class="arg">string</i></dt>
<dd></dd>
<dt><b class="option">-2value</b> <i class="arg">string</i></dt>
<dd></dd>
<dt><b class="option">-2string</b> <i class="arg">string</i></dt>
<dd><p>These options override the names of the functions used to access the C type.</p></dd>
<dt><b class="option">-trace</b> <i class="arg">bool</i></dt>
<dd><p>By default the <b class="const">TRACE...</b> statements embedded into the generated C code
of the new type are inactive.
This option allows them to activated. Note, this will be a source change,
affecting the package build. This is not a runtime flag.</p></dd>
</dl>
<p>The result of the command is an empty string.</p>
<p>The actual results are found in the header file generated by
the command.</p></dd>
<dt><a name="2"><b class="cmd">::critcl::objtype structure</b> <i class="arg">name</i> <i class="arg">spec</i> <span class="opt">?<i class="arg">option...</i>?</span></a></dt>
<dd><p>This command creates the C code for a custom <b class="type">Tcl_ObjType</b> with the
specified <i class="arg">name</i> and the structure fields defined by the <i class="arg">spec</i>.</p>
<p>Internally this form is reduced to a <b class="cmd">handle</b>, with the generator
not only emitting the boiler plate needed for the type itself, but also
emitting the code implementing the C structure and opaque type it uses.</p>
<p>The <i class="arg">spec</i> is expected to be a single list of alternating type and
field names, i.e. each type name is followed by the name of field the type
applies to.
The acceptable type names are all known Critcl argument types which have an
associated <b class="cmd">critcl::argtype2string</b> definition. This definition specifies
how to serialize a value of the type into a <b class="type">Tcl_DString*</b> variable.</p>
<p>Currently the only types doing so are a subset of the basic scalars,
namely <b class="type">int</b>, <b class="type">long</b>, <b class="type">boolean</b>, <b class="type">double</b>, and
<b class="type">float</b>, further their aliases, and the associated sets of common range
restrictions.</p>
<p>The nature of the string representation used for the new type is guided
by the options following <i class="arg">name</i> and <i class="arg">spec</i>.</p>
<dl class="doctools_options">
<dt><b class="option">-format</b> <b class="const">dict</b>|<b class="const">list</b></dt>
<dd><p>This option chooses between dictionary and list representations.  In a
dictionary representation the fields are named, enabling deserialization from
any order. In the list representation the values are simply listed in their
order of specification, and deserialized in that same order.</p>
<p>The default is <b class="const">dict</b>.</p></dd>
<dt><b class="option">-tagged</b> <i class="arg">boolean</i></dt>
<dd><p>This option determines if the string representation comes with a leading tag
indicating the type of the entire string value, or not.</p>
<p>The default is <b class="const">true</b>, i.e. <em>tagged</em>.</p></dd>
<dt><b class="option">-trace</b> <i class="arg">boolean</i></dt>
<dd><p>By default the <b class="const">TRACE...</b> statements embedded into the generated C code
of the new type are inactive.
This option allows them to activated. Note, this will be a source change,
affecting the package build. This is not a runtime flag.</p></dd>
</dl>
<p>The result of the command is an empty string.</p>
<p>The actual results are found in the header file generated by
the command.</p></dd>
</dl>
</div>
<div id="section3" class="doctools_section"><h2><a name="section3">Examples</a></h2>
<p>The examples show the various forms of specification, and for structure the
different possible string representations the generator can emit.</p>
<div id="subsection1" class="doctools_subsection"><h3><a name="subsection1">Handle</a></h3>
<pre class="doctools_example">
    # All defaults
    critcl::objtype handle point
    # C type override
    critcl::objtype handle point -type pointxy
    # Full override, C type and function names.
    critcl::objtype handle point -type pointxy	\\
        -ref      2d_aquire			\\
        -unref    2d_release			\\
        -refcount 2d_references			\\
        -2string  2d_serialize			\\
        -2value   2d_deserialize
</pre>
</div>
<div id="subsection2" class="doctools_subsection"><h3><a name="subsection2">Structure - Tagged Dict</a></h3>
<pre class="doctools_example">
    critcl::objtype structure pointxy {
        double x
        double y
    }
    # string rep: {pointxy {x 0.0 y 0.0}}
</pre>
</div>
<div id="subsection3" class="doctools_subsection"><h3><a name="subsection3">Structure - Dict</a></h3>
<pre class="doctools_example">
    critcl::objtype structure pointxy {
        double x
        double y
    } -tagged false
    # string rep: {x 0.0 y 0.0}
</pre>
</div>
<div id="subsection4" class="doctools_subsection"><h3><a name="subsection4">Structure - Tagged List</a></h3>
<pre class="doctools_example">
    critcl::objtype structure pointxy {
        double x
        double y
    } -format list
    # string rep: {pointxy 0.0 0.0}
    #                      x   y
</pre>
</div>
<div id="subsection5" class="doctools_subsection"><h3><a name="subsection5">Structure - List</a></h3>
<pre class="doctools_example">
    critcl::objtype structure pointxy {
        double x
        double y
    } -format list -tagged false
    # string rep: {0.0 0.0}
    #              x   y
</pre>
</div>
</div>
<div id="section4" class="doctools_section"><h2><a name="section4">Authors</a></h2>
<p>Andreas Kupries</p>
</div>
<div id="section5" class="doctools_section"><h2><a name="section5">Bugs, Ideas, Feedback</a></h2>
<p>This document, and the package it describes, will undoubtedly contain
bugs and other problems.
Please report such at <a href="https://github.com/andreas-kupries/critcl">https://github.com/andreas-kupries/critcl</a>.
Please also report any ideas for enhancements you may have for either
package and/or documentation.</p>
</div>
<div id="keywords" class="doctools_section"><h2><a name="keywords">Keywords</a></h2>
<p><a href="../index.html#key8">C code</a>, <a href="../index.html#key3">Embedded C Code</a>, <a href="../index.html#key24">Tcl_Obj</a>, <a href="../index.html#key25">Tcl_ObjType</a>, <a href="../index.html#key6">code generator</a>, <a href="../index.html#key0">compile &amp; run</a>, <a href="../index.html#key10">compiler</a>, <a href="../index.html#key1">dynamic code generation</a>, <a href="../index.html#key2">dynamic compilation</a>, <a href="../index.html#key9">generate package</a>, <a href="../index.html#key4">linker</a>, <a href="../index.html#key5">on demand compilation</a>, <a href="../index.html#key7">on-the-fly compilation</a></p>
</div>
<div id="category" class="doctools_section"><h2><a name="category">Category</a></h2>
<p>Glueing/Embedded C code</p>
</div>
<div id="copyright" class="doctools_section"><h2><a name="copyright">Copyright</a></h2>
<p>Copyright &copy; 2011-2018 Andreas Kupries</p>
</div>
</div></body></html>
