
<html><head>
<title>critcl::app - C Runtime In Tcl (CriTcl)</title>
<style type="text/css"><!--
    HTML {
	background: 	#FFFFFF;
	color: 		black;
    }
    BODY {
	background: 	#FFFFFF;
	color:	 	black;
    }
    DIV.doctools {
	margin-left:	10%;
	margin-right:	10%;
    }
    DIV.doctools H1,DIV.doctools H2 {
	margin-left:	-5%;
    }
    H1, H2, H3, H4 {
	margin-top: 	1em;
	font-family:	sans-serif;
	font-size:	large;
	color:		#005A9C;
	background: 	transparent;
	text-align:		left;
    }
    H1.title {
	text-align: center;
    }
    UL,OL {
	margin-right: 0em;
	margin-top: 3pt;
	margin-bottom: 3pt;
    }
    UL LI {
	list-style: disc;
    }
    OL LI {
	list-style: decimal;
    }
    DT {
	padding-top: 	1ex;
    }
    UL.toc,UL.toc UL, UL.toc UL UL {
	font:		normal 12pt/14pt sans-serif;
	list-style:	none;
    }
    LI.section, LI.subsection {
	list-style: 	none;
	margin-left: 	0em;
	text-indent:	0em;
	padding: 	0em;
    }
    PRE {
	display: 	block;
	font-family:	monospace;
	white-space:	pre;
	margin:		0%;
	padding-top:	0.5ex;
	padding-bottom:	0.5ex;
	padding-left:	1ex;
	padding-right:	1ex;
	width:		100%;
    }
    PRE.example {
	color: 		black;
	background: 	#f5dcb3;
	border:		1px solid black;
    }
    UL.requirements LI, UL.syntax LI {
	list-style: 	none;
	margin-left: 	0em;
	text-indent:	0em;
	padding:	0em;
    }
    DIV.synopsis {
	color: 		black;
	background: 	#80ffff;
	border:		1px solid black;
	font-family:	serif;
	margin-top: 	1em;
	margin-bottom: 	1em;
    }
    UL.syntax {
	margin-top: 	1em;
	border-top:	1px solid black;
    }
    UL.requirements {
	margin-bottom: 	1em;
	border-bottom:	1px solid black;
    }
--></style>
</head>
<! -- Generated from file '/net/nas/data/andreask/Dev/Critcl/v21/embedded/www/files/critcl_apppkg.html' by tcllib/doctools with format 'html'
   -->
<! -- Copyright &copy; ???????????????????
   -->
<! -- CVS: $Id$ critcl::app.n
   -->
<body><div class="doctools">
<hr> [
  <a href="../toc.html">Table Of Contents</a>
| <a href="../index.html">Keyword Index</a>
] <hr>
<h1 class="title">critcl::app(n) 2.1 doc &quot;C Runtime In Tcl (CriTcl)&quot;</h1>
<div id="name" class="section"><h2><a name="name">Name</a></h2>
<p>critcl::app - CriTcl Application Package Reference</p>
</div>
<div id="toc" class="section"><h2><a name="toc">Table Of Contents</a></h2>
<ul class="toc">
<li class="section"><a href="#toc">Table Of Contents</a></li>
<li class="section"><a href="#synopsis">Synopsis</a></li>
<li class="section"><a href="#section1">Description</a></li>
<li class="section"><a href="#section2">API</a></li>
<li class="section"><a href="#section3">Options</a></li>
<li class="section"><a href="#section4">Modes Of Operation/Use</a></li>
<li class="section"><a href="#section5">Package Structure</a></li>
<li class="section"><a href="#section6">Changes for version 2.1</a></li>
<li class="section"><a href="#section7">Authors</a></li>
<li class="section"><a href="#section8">Bugs, Ideas, Feedback</a></li>
<li class="section"><a href="#keywords">Keywords</a></li>
<li class="section"><a href="#category">Category</a></li>
<li class="section"><a href="#copyright">Copyright</a></li>
</ul>
</div>
<div id="synopsis" class="section"><h2><a name="synopsis">Synopsis</a></h2>
<div class="synopsis">
<ul class="requirements">
<li>package require <b class="pkgname">Tcl 8.4</b></li>
<li>package require <b class="pkgname">critcl::app <span class="opt">?2.1?</span></b></li>
<li>package require <b class="pkgname">critcl <span class="opt">?2?</span></b></li>
<li>package require <b class="pkgname">platform <span class="opt">?1.0.2?</span></b></li>
<li>package require <b class="pkgname">cmdline</b></li>
</ul>
<ul class="syntax">
<li><a href="#1"><b class="cmd">::critcl::app::main</b> <i class="arg">commandline</i></a></li>
</ul>
</div>
</div>
<div id="section1" class="section"><h2><a name="section1">Description</a></h2>
<p>Welcome to the <i class="term">C Runtime In Tcl</i>, <i class="term"><a href="critcl_pkg.html">CriTcl</a></i> for short, a
system to build C extension packages for Tcl on the fly, from C code
embedded within Tcl scripts, for all who wish to make their code go
faster.</p>
<p>This document is the reference manpage for the <b class="package">critcl::app</b>
package. Its intended audience are developers working on critcl's
internals.  Writers of packages with embedded C code can ignore this
document.
If you are in need of an overview of the whole system instead, please
go and read the <i class="term"><a href="critcl_introduction.html">Introduction To CriTcl</a></i>.</p>
<p>This package resides in the Application Layer of CriTcl.</p>
<p><img alt="arch_application" src="../image/arch_application.png"></p>
<p>,
implementing the functionality of the <i class="term"><a href="critcl_app.html">CriTcl Application</a></i>,
and through this, the mode <span class="sectref"><a href="#section4">generate package</a></span>.
The actual application is (only) a shim wrapping around this
package. It itself is build on top of the core package
<b class="package"><a href="critcl_pkg.html">critcl</a></b>.</p>
</div>
<div id="section2" class="section"><h2><a name="section2">API</a></h2>
<p>The package exports a single command</p>
<dl class="definitions">
<dt><a name="1"><b class="cmd">::critcl::app::main</b> <i class="arg">commandline</i></a></dt>
<dd><p>The <i class="arg">commandline</i> is a list of options and input files, in this order,
with both parts possibly empty.
The exact set of options supported, their meaning, and interaction is
detailed in section <span class="sectref"><a href="#section3">Options</a></span> below.
For a larger set of examples please see section &quot;Building Critcl Packages&quot;
in the document about <i class="term"><a href="critcl_usingit.html">Using CriTcl</a></i>.</p></dd>
</dl>
</div>
<div id="section3" class="section"><h2><a name="section3">Options</a></h2>
<p>The following options are understood</p>
<dl class="options">
<dt><b class="option">-I</b> path</dt>
<dd><p>This option specifies a single additional global include path to use
during compilation of &quot;<b class="file">.critcl</b>&quot; files. The last value will be
used if this is specified multiple times.</p></dd>
<dt><b class="option">-cache</b> path</dt>
<dd><p>This option specifies the path to the directory to use as the result
cache. If not specified it defaults to &quot;<b class="file">~/.critcl/&lt;platform&gt;</b>&quot;,
or, when generating a package (see option <b class="option">-pkg</b> below), to
&quot;<b class="file">~/.critcl/&lt;pid&gt;.&lt;epoch&gt;</b>&quot;,
When specified multiple times the last value is used.</p></dd>
<dt><b class="option">-clean</b></dt>
<dd><p>When specified the result cache is emptied, i.e. all files and
directories found inside are deleted) before compilation begins.
This option is irrelevant when generating a package (see option
<b class="option">-pkg</b> below) because this mode starts out with a unique and
empty result cache.</p></dd>
<dt><b class="option">-config</b> path</dt>
<dd><p>This option specifies the path to a custom configuration file,
allowing the user to use their own target specifications. If not
specified a hardwired default configuration embedded in the system
core is used instead.
When specified multiple times the last value is used.</p></dd>
<dt><b class="option">-debug</b> mode</dt>
<dd><p>This option activates compilation with debugging. It accepts the modes
below.
When specified multiple times the combination of all modes is used.</p>
<dl class="definitions">
<dt><b class="const">memory</b></dt>
<dd><p>This mode activates memory debugging of allocations made through the
Tcl core.</p></dd>
<dt><b class="const">symbols</b></dt>
<dd><p>This mode activates building of all &quot;<b class="file">.c</b>&quot; files with debugging
symbols.</p></dd>
<dt><b class="const">all</b></dt>
<dd><p>This mode activates both <b class="const">memory</b> and <b class="const">symbols</b>.</p></dd>
</dl></dd>
<dt><b class="option">-force</b></dt>
<dd><p>When specified compilation is always done, even if a shared library
for the file exists already. This effect can be had through cleaning
the cache (see above) as well, except that it is lazy in the
destruction of files and will not destroy files unrelated to the ones
we are building.
This option is irrelevant when generating a package (see option
<b class="option">-pkg</b> below) because this mode starts out with a unique and
empty result cache.</p></dd>
<dt><b class="option">-help</b></dt>
<dd><p>This option will cause the system to print a short help about command
line syntax and options and then exit the application.</p></dd>
<dt><b class="option">-keep</b></dt>
<dd><p>This option will cause the system to keep the &quot;<b class="file">.c</b>&quot; files
generated by a run in the result cache.
When generating a package (see option <b class="option">-pkg</b> below) this also
prevents the deletion of the unique result cache used by the run.
This option is intended for the debugging of <b class="cmd"><a href="critcl_pkg.html">critcl</a></b> itself,
where it may be necessary to inspect the generated C code.</p></dd>
<dt><b class="option">-libdir</b> path</dt>
<dd><p>This option specifies the path under which the packages generated via
option <b class="option">-pkg</b> are saved.
When specified multiple times the last value is used.
When not specified at all the default, &quot;<b class="file">lib</b>&quot;, is used. Note how
this is a relative path, placing the result into the current working
directory.</p></dd>
<dt><b class="option">-pkg</b></dt>
<dd><p>The default mode of the application is to build the &quot;<b class="file">.critcl</b>&quot;
files listed on the command line and save the results in the result
cache. Essentially pre-filling the cache with important packages,
cutting down on the time needed to use these packages.</p>
<p>This option activates the other mode, package generation.
In this mode the input files are processed first as usual, however
after that they are bundled into a single library and additional files
are generated to make this library usable as a regular Tcl package.</p>
<p>In this mode the options <b class="option">-clean</b> and <b class="option">-force</b> are
irrelevant and ignored. In contrast, the option <b class="option">-libdir</b> is
relevant only in this mode.</p>
<p>When this option is specified the basename of the first file argument
after the options is used as the name of the package to generate. If
the extension of that file indicates a shared library (&quot;<b class="file">.so</b>&quot;,
&quot;<b class="file">.sl</b>&quot;, &quot;<b class="file">.dylib</b>&quot;, and &quot;<b class="file">.dll</b>&quot;) it is also removed from
the set of input files. A &quot;<b class="file">.tcl</b>&quot; file is kept as part of the
input. A single file without extension is assumed to actually have a
&quot;<b class="file">.tcl</b>&quot; extension. A file without extension, but other input files
following is treated like the name of a shared library proper, and
removed from the set of input files.</p>
<p>Examples:</p>
<pre class="example">
	... -pkg ... foo
	=&gt; Package name is: foo
	=&gt; Input file is:   foo.tcl
</pre>
<pre class="example">
	... -pkg ... foo bar.tcl
	=&gt; Package name is: foo
	=&gt; Input file is:   bar.tcl
</pre>
<pre class="example">
	... -pkg ... foo.tcl
	=&gt; Package name is: foo
	=&gt; Input file is:   foo.tcl
</pre>
<pre class="example">
	... -pkg ... foo.so bar.tcl
	=&gt; Package name is: foo
	=&gt; Input file is:   bar.tcl
</pre>
</dd>
<dt><b class="option">-show</b></dt>
<dd><p>This option, when specified, will cause the system to print the
configuration of the chosen target to <b class="const">stdout</b> and then exit.
The choice of target can be influenced through the option
<b class="option">-target</b> (see below).</p></dd>
<dt><b class="option">-showall</b></dt>
<dd><p>This option, when specified, will cause the system to print the whole
chosen configuration file to <b class="const">stdout</b> and then exit.
The choice of configuration file can be influenced through the option
<b class="option">-config</b> (see above).</p></dd>
<dt><b class="option">-target</b> name</dt>
<dd><p>This option overrides the default choice of build target with
the user's choice.
When specified multiple times the last value is used.
The named target must exist in the chosen configuration file.
Use option <b class="option">-targets</b> (see below) to get a list of the
acceptable targets.
The choice of configuration file can be influenced through the option
<b class="option">-config</b> (see above).</p></dd>
<dt><b class="option">-targets</b></dt>
<dd><p>This option, when specified, will cause the system to print the list
of all known targets from the chosen configuration file to
<b class="const">stdout</b> and then exit.
The choice of configuration file can be influenced through the option
<b class="option">-config</b> (see above).</p></dd>
</dl>
</div>
<div id="section4" class="section"><h2><a name="section4">Modes Of Operation/Use</a></h2>
<p>CriTcl can be used in two different modes of operation, called</p>
<ol class="enumerated">
<li><p><i class="term"><a href="../index.html#key0">Compile &amp; Run</a></i>, and</p></li>
<li><p><i class="term"><a href="../index.html#key9">Generate Package</a></i></p></li>
</ol>
<p>Of these two <i class="term"><a href="../index.html#key0">Compile &amp; Run</a></i> came first and is the default when
using the package directly. In that case the package collects the C
fragments, builds them as needed, and caches the results for quick
reuse when the same code is used in the future again.</p>
<p>The second mode, <i class="term"><a href="../index.html#key9">Generate Package</a></i>, was introduced to enable
the creation of (prebuilt) deliverable packages which do not depend on
the existence of a build system, i.e. C compiler, on the target
machine.
This was originally done through the experimental <b class="cmd">Critbind</b> tool,
and is now handled by the <i class="term"><a href="critcl_app.html">CriTcl Application</a></i>, also named
<b class="cmd"><a href="critcl_pkg.html">critcl</a></b>.</p>
</div>
<div id="section5" class="section"><h2><a name="section5">Package Structure</a></h2>
<p>Packages generated by critcl have the following basic structure:</p>
<pre class="example">
&lt;TOP&gt;
+- pkgIndex.tcl
+- critcl-rt.tcl
+- license.terms (optional)
|
+- tcl (optional)
|  +- &lt;tsources files&gt;
|
+- &lt;platform&gt;
   +- &lt;shared library&gt;
</pre>
<p><em>Notes</em></p>
<ol class="enumerated">
<li><p>The file &quot;<b class="file">pkgIndex.tcl</b>&quot; is the standard package index file
expected by Tcl's package management. It is sourced during a search
for packages, and declares the package to Tcl with its files, and how
to handle them.</p></li>
<li><p>The file &quot;<b class="file">critcl-rt.tcl</b>&quot; is a helper file containing the
common code used by &quot;<b class="file">pkgIndex.tcl</b>&quot; to perform its tasks.</p></li>
<li><p>The file &quot;<b class="file">license.terms</b>&quot; is optional and appears only if
the &quot;<b class="file">.critcl</b>&quot; file the package is generated from used the command
<b class="cmd">critcl::license</b> to declare package author and license.</p></li>
<li><p>All files declared with the command <b class="cmd">critcl::tsources</b> are
put into the sub-directory &quot;<b class="file">tcl</b>&quot;.</p></li>
<li><p>The shared library generated by critcl is put into a
platform-specific sub-directory.</p></li>
</ol>
<p>The whole structure, and especially the last point, enable us
to later merge the results (for the same package, and version) for
multiple target platforms into a single directory structure without
conflict, by simply copying the top directories over each other. The
only files which can conflict are in the &lt;TOP&gt; and &quot;<b class="file">tcl</b>&quot;
directories, and for these we know that they are identical across
targets. The result of such a merge would look like:</p>
<pre class="example">
&lt;TOP&gt;
+- pkgIndex.tcl
+- critcl-rt.tcl
+- license.terms (optional)
|
+- tcl (optional)
|  +- &lt;tsources files&gt;
|
+- &lt;platform1&gt;
|  +- &lt;shared library1&gt;
+- &lt;platform2&gt;
|  +- &lt;shared library2&gt;
...
+- &lt;platformN&gt;
   +- &lt;shared libraryN&gt;
</pre>
</div>
<div id="section6" class="section"><h2><a name="section6">Changes for version 2.1</a></h2>
<ol class="enumerated">
<li><p>Fixed bug where <b class="cmd">critcl::tsources</b> interpreted relative
paths as relative to the current working directory instead of
relative to the &quot;<b class="file">.critcl</b>&quot; file using the command, as all other
commands of this type do.</p></li>
<li><p>Fixed internals, preventing information collected for multiple
&quot;<b class="file">.critcl</b>&quot; files to leak between them. Notably, <b class="cmd">critcl::tk</b>
is not a global configuration option anymore.</p></li>
<li><p>Fixed the command <b class="cmd">critcl::license</b> to be a null-operation
in mode &quot;compile &amp; run&quot;, instead of throwing an error.</p></li>
<li><p>Fixed the critcl application's interference with the &quot;compile &amp;
run&quot; result cache in <b class="option">-pkg</b> mode by having it use a wholly
separate (and by default transient) directory for that mode.</p></li>
<li><p>Fixed bug where changes to a &quot;<b class="file">.critcl</b>&quot; file did not result
in a rebuild for mode &quot;compile &amp; run&quot;. All relevant API commands now
ensure UUID changes.</p></li>
<li><p>Fixed bug in the backend handling of <b class="cmd">critcl::debug</b> where
the companion c-sources of a &quot;<b class="file">.critcl</b>&quot; file were not compiled
with debug options, although the &quot;<b class="file">.critcl</b>&quot; file was.</p></li>
<li><p>Fixed bug in <b class="cmd">critcl::debug</b> which prevented recognition of
mode &quot;all&quot; when it was not the first argument to the command.</p></li>
<li><p>Fixed bug in &quot;<b class="file">preload.c</b>&quot; preventing its compilation on
non-windows platforms.</p></li>
<li><p>Fixed long-standing bug in the handling of namespace qualifiers
in the command name argument of <b class="cmd">critcl::cproc</b> and
<b class="cmd">critcl::ccommand</b>. It is now possible to specify a fully
qualified command name without issues.</p></li>
<li><p>Extended/reworked <b class="cmd">critcl::tsources</b> to be the canonical
way of declaring &quot;<b class="file">.tcl</b>&quot; companion files even for mode &quot;compile &amp;
run&quot;.</p></li>
<li><p>Extended/reworked <b class="cmd">critcl::tsources</b> to allow the use of a
&quot;<b class="file">.critcl</b>&quot; file as its own Tcl companion file.</p></li>
<li><p>Extended <b class="cmd">critcl::framework</b> to internally check for OS X
build target, and to ignore the declaration if its not.</p></li>
<li><p>Extended <b class="cmd">critcl::failed</b> to be callable more than once in
a &quot;<b class="file">.critcl</b>&quot; file. The first call forces the build, if it was not
done already, to get the result. Further calls return the cached
result of the first call.</p></li>
<li><p>Extended the code handling the search for preloaded libraries
to print the paths it searched, making debugging of a search failure
easier.</p></li>
<li><p>Extended the handling of environment variable CC in the code
determining the compiler to use to deal with (i.e. remove) paths to
the compiler, compiler file extensions, and compiler options specified
after the compiler itself, leaving only the bare name of the compiler.</p></li>
<li><p>A new command <b class="cmd">critcl::tcl</b> can be used to declare the
version of Tcl minimally needed to build and run the &quot;<b class="file">.critcl</b>&quot;
file and package. Defaults to 8.4 if not declared. Extended critcl to
have the stubs and headers for all of Tcl 8.4, 8.5, and 8.6.</p></li>
<li><p>A new command <b class="cmd">critcl::load</b> forces the build and load of a
&quot;<b class="file">.critcl</b>&quot; file. This is the official way for overriding critcl's
default lazy-build-&amp;-load-on-demand scheme for mode &quot;compile &amp; run&quot;.</p>
<p><em>Note</em> that after using <b class="cmd">critcl::load</b> /
<b class="cmd">critcl::failed</b> in a &quot;<b class="file">.critcl</b>&quot; file it is not possible to
use critcl commands in that file anymore. Doing so will throw an
error.</p></li>
<li><p>Extended the generation of '#line' pragmas to use
<b class="cmd">info frame</b> (if available) to provide the C compiler with exact
line numbers into the &quot;<b class="file">.critcl</b>&quot; file for the reporting of
warnings and errors.</p></li>
<li><p>Extended <b class="cmd">critcl::check</b> with logging to help with
debugging build-time checks of the environment, plus an additional
optional argument to provide labeling.</p></li>
<li><p>Added a new command <b class="cmd">critcl::checklink</b> which not only
tries to check the environment via compiling the code, but also
its linkability.</p></li>
<li><p>Added a new command <b class="cmd">critcl::msg</b> for messaging, like
command <b class="cmd">critcl::error</b> is for error reporting. Likewise this is a
hook a user of the package is allowed to override. The default
implementation, used by mode <i class="term"><a href="../index.html#key0">compile &amp; run</a></i> does nothing. The
implementation for mode <i class="term"><a href="../index.html#key9">generate package</a></i> prints the message
to stdout.</p>
<p>Envisioned use is for the reporting of results determined by
<b class="cmd">critcl::check</b> and <b class="cmd">critcl::checklink</b> during building, to
help with debugging when something goes wrong with a check.</p></li>
<li><p>Exposed the argument processing internals of <b class="cmd">critcl::proc</b>
for use by advanced users. New commands</p>
<ol class="enumerated">
<li><p><b class="cmd">critcl::argnames</b></p></li>
<li><p><b class="cmd">critcl::argcnames</b></p></li>
<li><p><b class="cmd">critcl::argcsignature</b></p></li>
<li><p><b class="cmd">critcl::argvardecls</b></p></li>
<li><p><b class="cmd">critcl::argconversion</b></p></li>
</ol>
<p>See section <b class="sectref">Advanced Embedded C Code</b> for details.</p></li>
<li><p>Dropped the unused commands <b class="cmd">critcl::optimize</b> and
<b class="cmd">critcl::include</b>.</p></li>
<li><p>Dropped <b class="option">-lib</b> mode from the critcl application.</p></li>
<li><p>Dropped remnants of support for Tcl 8.3 and before.</p></li>
</ol>
</div>
<div id="section7" class="section"><h2><a name="section7">Authors</a></h2>
<p>Jean Claude Wippler, Steve Landers, Andreas Kupries</p>
</div>
<div id="section8" class="section"><h2><a name="section8">Bugs, Ideas, Feedback</a></h2>
<p>This document, and the package it describes, will undoubtedly contain
bugs and other problems.
Please report such at
<a href="https://chiselapp.com/user/andreas_kupries/repository/CriTcl/reportlist">https://chiselapp.com/user/andreas_kupries/repository/CriTcl/reportlist</a>.
Please also report any ideas for enhancements you may have for either
package and/or documentation.</p>
<p><em>Note</em> that this is not critcl's official bug tracker, but
the repository where inofficial and experimental development of critcl
is taking place. It is the best which can be done because an official
bug tracker does not exist.</p>
</div>
<div id="keywords" class="section"><h2><a name="keywords">Keywords</a></h2>
<p><a href="../index.html#key8">C code</a>, <a href="../index.html#key3">Embedded C Code</a>, <a href="../index.html#key6">code generator</a>, <a href="../index.html#key0">compile &amp; run</a>, <a href="../index.html#key10">compiler</a>, <a href="../index.html#key1">dynamic code generation</a>, <a href="../index.html#key2">dynamic compilation</a>, <a href="../index.html#key9">generate package</a>, <a href="../index.html#key4">linker</a>, <a href="../index.html#key5">on demand compilation</a>, <a href="../index.html#key7">on-the-fly compilation</a></p>
</div>
<div id="category" class="section"><h2><a name="category">Category</a></h2>
<p>Glueing C code</p>
</div>
<div id="copyright" class="section"><h2><a name="copyright">Copyright</a></h2>
<p>Copyright &copy; ???????????????????</p>
</div>
</div></body></html>
